<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- namespace는 반드시 mapper 위치로 설정해야 된다. -->
<mapper namespace="com.ict.finalpj.domain.deal.mapper.DealMapper">

  <!-- 구분 1 -->
  <select id="getDealMainList" resultType="DealVO">
    select * from pjdeal order by dealIdx desc
  </select>

 <select id="getDealFileOne" parameterType="String" resultType="FileVo">
    SELECT * FROM pjfile 
    WHERE fileTableIdx = #{dealIdx} 
    AND fileOrder = 0
    LIMIT 1
  </select>

  <select id="getDealDetail" parameterType="String" resultType="com.ict.finalpj.domain.deal.vo.DealVO">
    SELECT * FROM pjdeal WHERE dealIdx = #{dealIdx}
  </select>

  <select id="getDealFileDetail" parameterType="String" resultType="FileVo">
    SELECT * FROM pjfile 
    WHERE fileTableIdx = #{dealIdx} 
    AND fileTableType = 2
    ORDER BY fileOrder ASC
  </select>

  <insert id="getDealWrite" parameterType="DealVO">
    INSERT INTO pjdeal 
    (dealIdx, 
      dealSellerUserIdx,
      dealSellerNick,
      dealTitle, 
      dealCategory, 
      dealStatus, 
      dealDescription, 
      dealPrice, 
      dealPackage, 
      dealDirect, 
      dealDirectContent, 
      dealCount, 
      dealRegDate)
    VALUES 
    (#{dealIdx},
      #{dealSellerUserIdx},
      #{dealSellerNick},
      #{dealTitle},
      #{dealCategory},
      #{dealStatus},
      #{dealDescription},
      #{dealPrice},
      #{dealPackage},
      #{dealDirect},
      #{dealDirectContent},
      #{dealCount},
      NOW())
  </insert>

  <insert id="getIDealFileInsert" parameterType="FileVo">
    INSERT INTO pjfile 
    (fileTableType, 
     fileTableIdx, 
     fileName, 
     fileOrder, 
     fileCreated) 
    VALUES 
    (2, 
     #{fileTableIdx},
     #{fileName}, 
     #{fileOrder}, 
     NOW())
  </insert>

  <delete id="getDealFileDelete" parameterType="FileVo">
    DELETE FROM pjfile 
    WHERE fileTableIdx = #{dealIdx} 
    AND fileName = #{fileName}
    AND fileOrder = #{fileOrder}
  </delete>

  <update id="getDealFileUpdate">
    UPDATE pjfile 
    SET fileOrder = (
      SELECT tmp.new_order 
      FROM (
        SELECT fileName, (@row_number:=@row_number + 1) - 1 AS new_order
        FROM pjfile, (SELECT @row_number:=0) AS t
        WHERE fileTableIdx = #{dealIdx}
        ORDER BY fileOrder ASC
      ) AS tmp
      WHERE tmp.fileName = pjfile.fileName
    )
    WHERE fileTableIdx = #{dealIdx}
  </update>

  <update id="getDealUpdate" parameterType="DealVO">
    UPDATE pjdeal 
    SET 
        dealTitle = #{dealTitle}, 
        dealCategory = #{dealCategory}, 
        dealStatus = #{dealStatus}, 
        dealDescription = #{dealDescription}, 
        dealPrice = #{dealPrice}, 
        dealPackage = #{dealPackage}, 
        dealDirect = #{dealDirect},
        dealDirectContent = #{dealDirectContent},
        dealCount = #{dealCount} 
    WHERE dealIdx = #{dealIdx}
  </update>



  <!-- 구분 2 -->

 <select id="getDealManagement" parameterType="String" resultType="DealVO">
    select * from pjdeal where dealSellerUserIdx = #{userIdx}
  </select>

  <select id="getDealFileList" parameterType="String" resultType="FileVo">
    select * from pjfile 
    where fileTableIdx = #{dealIdx} order by fileOrder asc
  </select>

  <update id="updateFileOrder">
    UPDATE file_table 
    SET file_order = #{newOrder}
    WHERE file_table_idx = #{dealIdx} 
    AND file_name = #{fileName}
  </update>


</mapper>